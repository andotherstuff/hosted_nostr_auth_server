(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const w=(e,t)=>t.some(n=>e instanceof n);let D,P;function A(){return D||(D=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function N(){return P||(P=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const E=new WeakMap,m=new WeakMap,g=new WeakMap;function T(e){const t=new Promise((n,i)=>{const r=()=>{e.removeEventListener("success",s),e.removeEventListener("error",o)},s=()=>{n(u(e.result)),r()},o=()=>{i(e.error),r()};e.addEventListener("success",s),e.addEventListener("error",o)});return g.set(t,e),t}function U(e){if(E.has(e))return;const t=new Promise((n,i)=>{const r=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",o),e.removeEventListener("abort",o)},s=()=>{n(),r()},o=()=>{i(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",s),e.addEventListener("error",o),e.addEventListener("abort",o)});E.set(e,t)}let b={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return E.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return u(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function K(e){b=e(b)}function j(e){return N().includes(e)?function(...t){return e.apply(I(this),t),u(this.request)}:function(...t){return u(e.apply(I(this),t))}}function R(e){return typeof e=="function"?j(e):(e instanceof IDBTransaction&&U(e),w(e,A())?new Proxy(e,b):e)}function u(e){if(e instanceof IDBRequest)return T(e);if(m.has(e))return m.get(e);const t=R(e);return t!==e&&(m.set(e,t),g.set(t,e)),t}const I=e=>g.get(e);function V(e,t,{blocked:n,upgrade:i,blocking:r,terminated:s}={}){const o=indexedDB.open(e,t),c=u(o);return i&&o.addEventListener("upgradeneeded",a=>{i(u(o.result),a.oldVersion,a.newVersion,u(o.transaction),a)}),n&&o.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),c.then(a=>{s&&a.addEventListener("close",()=>s()),r&&a.addEventListener("versionchange",d=>r(d.oldVersion,d.newVersion,d))}).catch(()=>{}),c}const F=["get","getKey","getAll","getAllKeys","count"],$=["put","add","delete","clear"],h=new Map;function x(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(h.get(t))return h.get(t);const n=t.replace(/FromIndex$/,""),i=t!==n,r=$.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!(r||F.includes(n)))return;const s=async function(o,...c){const a=this.transaction(o,r?"readwrite":"readonly");let d=a.store;return i&&(d=d.index(c.shift())),(await Promise.all([d[n](...c),r&&a.done]))[0]};return h.set(t,s),s}K(e=>({...e,get:(t,n,i)=>x(t,n)||e.get(t,n,i),has:(t,n)=>!!x(t,n)||e.has(t,n)}));const z=["continue","continuePrimaryKey","advance"],C={},B=new WeakMap,O=new WeakMap,H={get(e,t){if(!z.includes(t))return e[t];let n=C[t];return n||(n=C[t]=function(...i){B.set(this,O.get(this)[t](...i))}),n}};async function*W(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,H);for(O.set(n,t),g.set(n,I(t));t;)yield n,t=await(B.get(n)||t.continue()),B.delete(n)}function k(e,t){return t===Symbol.asyncIterator&&w(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&w(e,[IDBIndex,IDBObjectStore])}K(e=>({...e,get(t,n,i){return k(t,n)?W:e.get(t,n,i)},has(t,n){return k(t,n)||e.has(t,n)}}));console.log("Main script loaded via Vite.");const _="chusme-auth-vault",Y=1,y="encryptedKeys";let l=null;async function G(){return l||(l=await V(_,Y,{upgrade(e){e.objectStoreNames.contains(y)||(e.createObjectStore(y,{keyPath:"id"}),console.log(`Object store ${y} created.`))}}),console.log("Database initialized."),l)}document.addEventListener("DOMContentLoaded",async()=>{try{await G()}catch(o){console.error("Failed to initialize database:",o),alert("Error initializing local storage. Key management will not work.");return}const e=document.getElementById("generate-key"),t=document.getElementById("load-key"),n=document.getElementById("copy-connection-string"),i=document.getElementById("passphrase"),r=document.getElementById("key-status"),s=document.getElementById("nip46-connection-string");if(!e||!t||!n||!i||!r||!s){console.error("One or more required HTML elements not found."),alert("Initialization Error: UI elements missing. Cannot proceed.");return}e.addEventListener("click",async()=>{if(!i.value){alert("Please enter a passphrase.");return}console.log("Generate & Encrypt Key clicked"),r.textContent="Generating key...";try{const c=new Uint8Array(32).fill(1),a=new Uint8Array(33).fill(2),d=L(a),p=window.crypto.getRandomValues(new Uint8Array(16)),v=new Uint8Array(32).fill(3);console.log("Derived key (stub)",v);const M=new Uint8Array(c.length+16).fill(4),S={id:1,publicKeyHex:d,encryptedNsecBlob:M,argonSalt:p};if(!l)throw new Error("Database not initialized");await l.put(y,S),r.textContent=`Key generated & encrypted. Pubkey: ${d.substring(0,10)}...`,f(d),alert("Key generation complete. Encrypted key stored locally.")}catch(c){console.error("Key generation/encryption failed:",c),r.textContent="Error generating key.",alert(`Error: ${c.message}`)}}),t.addEventListener("click",async()=>{if(!i.value){alert("Please enter a passphrase.");return}console.log("Load Encrypted Key clicked"),r.textContent="Loading key...";try{if(!l)throw new Error("Database not initialized");const c=await l.get(y,1);if(!c)throw new Error("No key found in local storage.");const a=c,d=new Uint8Array(32).fill(3),p=new Uint8Array(32).fill(1);console.log("Decrypted Nsec (stub - DO NOT LOG IN PROD):",L(p)),r.textContent=`Key loaded. Pubkey: ${a.publicKeyHex.substring(0,10)}...`,f(a.publicKeyHex),alert("Key loading complete.")}catch(c){console.error("Key loading/decryption failed:",c),r.textContent="Error loading key.",alert(`Error: ${c.message}`)}}),n.addEventListener("click",()=>{var o;if((o=s.textContent)!=null&&o.includes("<YOUR_PUBKEY>")){alert("Please generate or load a key first.");return}navigator.clipboard.writeText(s.textContent??"").then(()=>alert("Connection string copied to clipboard!")).catch(c=>console.error("Failed to copy text: ",c))});try{if(!l)throw new Error("Database not initialized");const o=await l.get(y,1);if(o){const c=o;r.textContent=`Existing key found. Pubkey: ${c.publicKeyHex.substring(0,10)}...`,f(c.publicKeyHex)}else r.textContent="Status: No key loaded.",f()}catch(o){console.error("Failed to load initial key state:",o),r.textContent="Error loading key status.",f()}});function f(e="<YOUR_PUBKEY>"){const t=document.getElementById("nip46-connection-string");if(t){const n=window.location.origin;t.textContent=`nostrconnect://${e}?relay=${n}`}}function L(e){return Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}
//# sourceMappingURL=index-DXRWorLZ.js.map
